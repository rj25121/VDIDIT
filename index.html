<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vastu Pro Analyzer |
AI Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
:root {
            /* Pastel Blue & White Theme */
            --color-primary: #60a5fa;
/* Blue 400 - Main Accent */
            --color-secondary: #93c5fd;
/* Blue 300 - Light Accent */
            --color-background: #f0f8ff;
/* Alice Blue / Lightest Pastel */
            --color-surface-base: rgba(255, 255, 255, 0.6);
/* Semi-transparent White for Glass */
            --color-text-dark: #1e3a8a;
/* Blue 800 - Deep Blue Text */
            --color-text-light: #6b7280;
/* Gray 500 */
            --color-chat-bg-user: #e0f2fe;
/* Blue 50 */
            --color-chat-bg-ai: #fff;
}
        body {
            font-family: 'Inter', sans-serif;
background-color: var(--color-background);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--color-text-dark);
            padding: 16px;
}

        /* Glassmorphism Card Style */
        .glass-card {
            background-color: var(--color-surface-base);
backdrop-filter: blur(8px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
}

        /* Step Indicator Styles */
        .step-indicator {
            transition: all 0.3s ease;
}
        .step-active {
            color: var(--color-primary);
border-bottom: 2px solid var(--color-primary);
            font-weight: 600;
        }

        /* Button Styles */
        .primary-btn {
            background-color: var(--color-primary);
color: white;
            transition: background-color 0.2s;
            box-shadow: 0 4px var(--color-text-dark);
        }
        .primary-btn:hover:not(:disabled) {
            background-color: #3b82f6;
/* Blue 500 */
        }
        .primary-btn:active:not(:disabled) {
            transform: translateY(2px);
box-shadow: 0 2px var(--color-text-dark);
        }
        .primary-btn:disabled {
            background-color: #93c5fd;
/* Blue 300 */
            cursor: not-allowed;
            box-shadow: none;
}
        
        /* Checkbox Styles for new step */
        .concern-checkbox:checked {
            background-color: var(--color-primary);
            border-color: var(--color-text-dark);
        }

        /* Compass Visual */
        #compassNeedle {
            transition: transform 0.1s linear;
}

        /* --- Report Formatting --- */
        #reportContent strong {
            /* Targeted styles for the AI's section titles (e.g., **II. Assessment**) */
            display: block;
margin-top: 1.5rem;
            margin-bottom: 0.5rem;
            font-size: 1.15rem;
            font-weight: 800;
            color: #f97316;
/* Orange color for headings */
            border-bottom: 2px solid #93c5fd;
/* Light Blue border */
            padding-bottom: 0.25rem;
}
        #reportContent {
            line-height: 1.6;
}
        .report-section p {
            margin-bottom: 1em;
/* Ensures clear paragraph separation */
        }
        
        /* Image Grid Styling for Captured Frames */
        .image-gallery {
            display: grid;
grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 0.5rem;
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            border-top: 2px solid #ddd;
            padding-top: 0.5rem;
}
        .frame-item {
            border: 1px solid #ccc;
border-radius: 0.5rem;
            overflow: hidden;
            text-align: center;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}
        .frame-item img {
            width: 100%;
height: auto;
            object-fit: cover;
            aspect-ratio: 1/1; 
        }
        .text-xxs {
            font-size: 0.6rem;
}

        /* --- Live Overlay Styles --- */
        #compassOverlay {
            pointer-events: none;
/* Allows clicks/touches to pass through to the elements beneath (i.e., the video) */
        }
        #overlayHeading {
            /* Large degree number */
            font-size: 2.25rem;
/* 3xl */
        }

        /* Chatbot Styles */
        .chat-message {
            max-width: 85%;
padding: 8px 12px;
            border-radius: 12px;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .user-message {
            background-color: var(--color-chat-bg-user);
align-self: flex-end;
            margin-left: auto;
            border-top-right-radius: 2px;
        }
        .ai-message {
            background-color: var(--color-chat-bg-ai);
align-self: flex-start;
            margin-right: auto;
            border-top-left-radius: 2px;
            border: 1px solid #e0e7ff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

        /* --- PRINT-FRIENDLY STYLES --- */
        @media print {
            /* Hide all .no-print elements */
            .no-print {
                display: none !important;
            }
            
            /* Reset body for printing */
            body {
                padding: 0;
                margin: 0;
                background-color: #fff;
            }

            /* Make the report view fill the page */
            #reportView {
                visibility: visible;
                display: block;
                width: 100%;
                position: relative;
            }

            /* Make the report content visible and printable */
            #reportContent {
                visibility: visible;
                display: block;
                width: 100%;
                height: auto;
                overflow-y: visible; /* Show all content */
                background: #fff;
                border: none;
                box-shadow: none;
                backdrop-filter: none;
                padding: 0.5in; /* Reduced padding */
                font-size: 11pt;
                color: #000;
            }
            
            /* Ensure report titles print well */
            #reportContent strong {
                color: #000; /* Black text, not orange */
                border-bottom: 2px solid #ccc;
                page-break-after: avoid;
            }
            
            /* Ensure images in the gallery print */
            .image-gallery img {
                visibility: visible;
            }
        }

    </style>
</head>
<body class="p-4 sm:p-8">
    <div id="appContainer" class="glass-card w-full max-w-sm sm:max-w-xl md:max-w-2xl p-6 space-y-6">

        <h1 class="text-xl sm:text-2xl font-extrabold text-center no-print">Vastu Pro Analyzer |
AI Edition</h1>
        <p class="text-xs text-center text-gray-500 no-print">Generate a Vastu Shastra report using your device's sensors.</p>

        <div class="flex flex-wrap justify-center text-center text-sm border-b pb-2 border-gray-200 no-print">
            <div id="step1" class="step-indicator m-1 min-w-[60px]">1. FAQ</div>
            <div id="step2" class="step-indicator m-1 min-w-[60px]">2.
Sensors</div>
            <div id="step3" class="step-indicator m-1 min-w-[60px]">3. Context</div>
            <div id="step4" class="step-indicator m-1 min-w-[60px]">4.
Location</div>
            <div id="step5" class="step-indicator m-1 min-w-[60px]">5.
Scan</div>
            <div id="step6" class="step-indicator m-1 min-w-[60px]">6.
Report & Chat</div>
        </div>

        <div id="stepContent1" class="step-content no-print">
            <div class="glass-card p-4 rounded-lg border-2 border-blue-100 h-96 overflow-y-auto">
                <h3 class="font-bold text-lg text-blue-800 mb-3"><i class="fas fa-question-circle mr-2"></i>User FAQ & How-To</h3>
                <div class="text-sm text-gray-700 space-y-4">
                    <div>
                        <p class="font-bold text-blue-700">Q: How do I get the most accurate scan?</p>
                        <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> Stand in the center of the room and turn in a slow, 360-degree circle. Make sure the room is well-lit so the AI can see everything clearly. The scan takes about 16 seconds.</p>
                    </div>
                    <div>
                        <p class="font-bold text-blue-700">Q: What is the "Holistic Context" in Step 3?</p>
                        <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> This is an optional but powerful step. By telling the AI your concerns (e.g., "Financial", "Health"), it can tailor the Vastu remedies specifically to help you with those problems.</p>
                    </div>
                    <div>
                        <p class="font-bold text-blue-700">Q: What is the "Location" in Step 4?</p>
                        <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> This is the most critical step for an accurate report. The AI needs to know *where the room is located* within the whole house. For example, a "Kitchen" (Step 4a) located in the "South-East" (Step 4b) is a very different Vastu analysis than a "Kitchen" in the "North-East".</p>
                    </div>
                    <div>
                        <p class="font-bold text-blue-700">Q: What's the difference between the two report buttons?</p>
                        <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A: "Formal Report"</strong> gives a full, 5-section analysis with simple, practical remedies. <strong>"Expert Analysis"</strong> gives a short, bulleted list of high-stakes, structural remedies (like moving a wall) that a human expert might suggest.</p>
                    </div>
                     <div>
                        <p class="font-bold text-blue-700">Q: My report failed or was empty. What do I do?</p>
                        <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> This can happen if the images are too dark or blurry, triggering the AI's safety filters. Please try scanning again in a room with better lighting.</p>
                    </div>
                    <div>
                        <p class="font-bold text-blue-700">Q: Can I scan just one wall?</p>
                        <p class="mt-1 pl-2 border-l-2 border-blue-200"><strong>A:</strong> No. The app is designed to capture all 8 directions in a full 360-degree scan to analyze every Vastu zone, not just one.</p>
                    </div>
                </div>
            </div>
            <button id="tipsNextButton" class="primary-btn w-full p-3 rounded-lg font-bold mt-6">
                Next: Activate Sensors <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
        <div id="stepContent2" class="step-content hidden no-print">
            <p class="text-sm text-center text-gray-600 mb-4">Please grant permission to access your device's sensors.</p>
            <div class="flex justify-center items-center p-4">
                <div class="relative w-24 h-24 sm:w-32 sm:h-32 bg-white rounded-full border-4 border-gray-300 flex items-center justify-center">
                    <i class="fas fa-compass text-6xl text-gray-400"></i>
                    <i id="compassNeedle" 
class="fas fa-arrow-up absolute text-red-500 text-3xl transition-transform" style="transform: rotate(0deg);"></i>
                </div>
            </div>
            <p class="text-center font-bold text-lg" id="headingDisplay">Heading: N/A</p>
            <p class="text-center text-xs text-gray-500 mb-4" id="sensorStatus">Sensors: Inactive</p>
            <button id="compassButton" class="primary-btn w-full p-3 rounded-lg font-bold">
           
      <i class="fas fa-magic mr-2"></i>Activate Sensors
            </button>
        </div>

        <div id="stepContent3" class="step-content hidden no-print">
            <p class="text-sm text-center text-gray-600 mb-4">This step is optional, but helps the AI personalize your report.</p>
            <div class="glass-card p-4 mb-4">
                <label class="block text-sm font-bold text-gray-700 mb-3">
                    Step 3a: What are your primary concerns? (Optional)
                </label>
                <div id="userConcernsContainer" class="grid grid-cols-2 gap-2 text-sm">
                    <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                        <input type="checkbox" class="concern-checkbox" value="Financial">
                        <span><i class="fas fa-wallet mr-1"></i> Financial</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                        <input type="checkbox" class="concern-checkbox" value="Health">
                        <span><i class="fas fa-heartbeat mr-1"></i> Health</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                        <input type="checkbox" class="concern-checkbox" value="Relationships">
                        <span><i class="fas fa-users mr-1"></i> Relationships</span>
                    </label>
                    <label class="flex items-center space-x-2 p-2 bg-white/50 rounded-lg">
                        <input type="checkbox" class="concern-checkbox" value="Career">
                        <span><i class="fas fa-briefcase mr-1"></i> Career</span>
                    </label>
                </div>
            </div>

            <div class="glass-card p-4">
                <label class="block text-sm font-bold text-gray-700 mb-2">
                    Step 3b: What is surrounding the property? (Optional)
                </label>
                <div class="space-y-2">
                    <input type="text" id="surroundingsWater" placeholder="E.g., River in North, Lake in East"
                           class="w-full p-3 border border-gray-300 rounded-lg text-gray-800 focus:ring-blue-500 focus:border-blue-500" data-key="Water Body">
                    <p class="text-xs text-gray-500 mt-1">Water body (lake, river, etc.) and its direction?</p>
                    
                    <input type="text" id="surroundingsHills" placeholder="E.g., Mountain in South-West"
                           class="w-full p-3 border border-gray-300 rounded-lg text-gray-800 focus:ring-blue-500 focus:border-blue-500" data-key="Hills">
                    <p class="text-xs text-gray-500 mt-1">Hills or large structures and their direction?</p>
                </div>
            </div>

            <button id="holisticNextButton" class="primary-btn w-full p-3 rounded-lg font-bold mt-6">
                Next: Specify Location <i class="fas fa-arrow-right ml-2"></i>
            </button>
        </div>
        <div id="stepContent4" class="step-content hidden no-print">
            <p class="text-sm text-center text-gray-600 mb-4">This step is **required** for an accurate report. The AI needs this context.</p>
            <p class="text-center text-sm text-gray-500 mb-4 font-bold">
                Step 4a: Select the area you are currently in.
            </p>
      
 
            <div id="roomSelectionContainer" class="flex flex-wrap justify-center gap-3 p-4 glass-card mb-4">
            </div>
            <p class="text-center text-xs text-gray-500 mb-4" id="currentRoomDisplay">Current Area: General Property Scan (Central/General Area)</p>

            <div class="mb-6 p-4 glass-card">
                <label for="roomLocationInput" class="block text-sm font-bold text-gray-700 mb-2">
       
              Step 4b: Where is this area located within the whole property (The C-Point Context)?
</label>
                <input type="text" id="roomLocationInput" placeholder="E.g., North-East, South-West, Center (Required)" 
                       class="w-full p-3 border border-gray-300 rounded-lg text-gray-800 focus:ring-blue-500 focus:border-blue-500">
                <p class="text-xs text-gray-500 mt-1">This context is critical for zone compliance analysis (e.g., "The Kitchen is in the South-East zone of the house").</p>
         
   </div>
            
            <div class="mb-6 p-4 glass-card">
                <label for="floorNumberInput" class="block text-sm font-bold text-gray-700 mb-2">
                    Step 4c: Which floor is this area located on?
</label>
                <input type="text" id="floorNumberInput" placeholder="E.g., 1st Floor, 2nd Floor, Ground Floor (Required)" 
                       class="w-full p-3 border border-gray-300 rounded-lg text-gray-800 focus:ring-blue-500 focus:border-blue-500">
                <p class="text-xs text-gray-500 mt-1">This context is relevant for Vastu energy flow (e.g., lower floors have stronger earth elements).</p>
          
  </div>
            
            <button id="cameraButton" class="primary-btn w-full p-3 rounded-lg font-bold" disabled>
                <i class="fas fa-camera mr-2"></i>Activate Camera for: General Property Scan
            </button>
        </div>

        <div id="stepContent5" class="step-content hidden no-print">
            
<p class="text-sm text-center text-gray-600 mb-4">Hold your device steady and turn in a slow 360° circle to capture all zones.</p>
            <div id="cameraContainer" class="glass-card overflow-hidden mb-4 relative">
                <video id="cameraVideo" autoplay playsinline class="bg-gray-200 hidden"></video>
                
                <div id="compassOverlay" class="absolute w-full h-full flex flex-col justify-between p-4 pointer-events-none z-50">
                    
<div class="text-center">
                        <span class="inline-block p-1 px-3 bg-black bg-opacity-70 text-white text-3xl font-extrabold rounded-lg shadow-xl" id="overlayHeading">N/A</span>
                    </div>
                    <div class="text-center self-center mb-4">
                     
   <span class="inline-block p-1 px-3 bg-black bg-opacity-70 text-white text-base rounded-lg font-semibold" id="overlayZone">Zone: Unknown</span>
                    </div>
                </div>

                <div id="cameraFallback" class="w-full h-full bg-gray-200 flex flex-col items-center justify-center text-center p-4 absolute top-0 left-0">
                    <i 
class="fas fa-video camera-icon"></i>
                    <p class="mt-2 text-sm text-gray-500">Camera access is required for Vastu analysis.</p>
                </div>
            </div>
         
            <p class="text-center text-sm mb-4">
                <span 
id="captureCount">0/8</span> Segments Captured. Scan takes ~16 seconds.
            </p>

            <button id="captureButton" class="primary-btn w-full p-3 rounded-lg font-bold mb-4" disabled>
                <i class="fas fa-location-arrow mr-2"></i>Start 16-Second Vastu Scan
            </button>
 
   
            <div id="captureProgressContainer" class="h-2 bg-gray-200 rounded-full mt-2 mb-4 hidden">
                <div id="captureProgress" class="h-2 bg-green-500 rounded-full transition-all duration-100"></div>
            </div>
            <div id="gallery" class="flex flex-wrap gap-2 justify-center p-2 border-dashed border-2 border-gray-300 rounded-lg bg-white overflow-y-auto max-h-40">
            </div>
        </div>

        <div id="stepContent6" class="step-content hidden">
            
            <div id="reportLoader" 
class="text-center py-8 hidden no-print">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-500"></i>
                <p class="mt-4 font-semibold text-gray-600">Generating Formal Report...</p>
                <p class="text-xs text-gray-500 mt-2">The process may take a few seconds.</p>
            </div>

           
 <div class="flex border-b border-gray-200 mb-4 no-print">
                <button id="reportTab" class="py-2 px-4 text-sm font-bold text-gray-600 border-b-2 border-transparent transition-colors hover:bg-gray-50 active-tab-style">
                    <i class="fas fa-file-alt mr-1"></i> Full Report
                </button>
                <button id="chatTab" class="py-2 px-4 text-sm font-bold text-gray-600 border-b-2 border-transparent transition-colors 
hover:bg-gray-50">
                    <i class="fas fa-comment-dots mr-1"></i> Vastu Chatbot
                </button>
            </div>


            <div id="reportView" class="tab-content">
                <div id="reportContent" class="glass-card p-4 h-96 overflow-y-auto text-sm report-section">
          Awaiting Scan Data.
</div>
            </div>
            
            <div id="chatView" class="tab-content hidden no-print">
                <div id="chatMessages" class="glass-card p-4 h-96 overflow-y-auto text-sm flex flex-col space-y-2">
                    <div class="ai-message chat-message text-gray-700">
           <i class="fas fa-robot mr-1 text-blue-500"></i>
                        Hello!
I am your Vastu AI Assistant. Ask me a general question about Vastu, or ask me for details about the report you just generated (e.g., "Tell me more about the North-East zone in my report").
</div>
                </div>
                <div class="flex mt-4">
                    <input type="text" id="chatInput" placeholder="Ask your Vastu question..." class="flex-1 p-3 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500 text-gray-800" disabled>
                    <button id="sendChatButton" class="primary-btn p-3 rounded-r-lg font-bold" disabled>
                   <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>


            <div class="mt-4 flex flex-wrap -mx-1 no-print">
                <button id="deepAnalysisButton" class="primary-btn p-3 rounded-lg font-bold bg-blue-500 hover:bg-blue-600 w-full sm:w-auto sm:flex-1 m-1" style="box-shadow: 0 4px #1d4ed8;" disabled>
                    <i class="fas fa-exclamation-triangle mr-2"></i>Expert Analysis
                </button>
               
 <button id="analyzeButton" class="primary-btn p-3 rounded-lg font-bold w-full sm:w-auto sm:flex-1 m-1" disabled>
                    <i class="fas fa-chart-area mr-2"></i>Formal Report
                 </button>
                <button id="saveReportButton" class="primary-btn p-3 rounded-lg font-bold bg-green-500 hover:bg-green-600 w-[calc(50%-0.5rem)] sm:w-auto m-1 hidden" style="box-shadow: 0 4px #047857;">
                    <i class="fas 
fa-file-export mr-2"></i>Export .txt
                </button>
                <button id="printReportButton" class="primary-btn p-3 rounded-lg font-bold bg-gray-500 hover:bg-gray-600 w-[calc(50%-0.5rem)] sm:w-auto m-1 hidden" style="box-shadow: 0 4px #4b5563;">
                    <i class="fas fa-print mr-2"></i>Print/Save PDF
                </button>
            </div>
            
            </div>

        </div>

    <canvas id="captureCanvas" style="display:none;" class="no-print"></canvas>


    <script type="module">
       const renderApiUrl="https://vdidit.onrender.com";let currentHeading=null;let isCompassActive=!1;let isCameraActive=!1;let isCapturing=!1;let isReportGenerating=!1;let isChatGenerating=!1;let videoStream=null;let capturedFrames=[];let fullReportMarkdown="";let chatContextSummary="";let chatHistory=[];let simulationInterval;let captureInterval;let sensorCheckTimeout;const totalCaptures=8;const captureIntervalTime=2000;const scanDuration=totalCaptures*(captureIntervalTime/1000);let currentRoomTag="General Property Scan (Central/General Area)";let roomLocationInHouse="";let floorNumber="";let userIssues=[];let propertySurroundings={};let stepContents,stepIndicators,tipsNextButton,headingDisplay,sensorStatus,compassNeedle,compassButton,cameraButton,captureCanvas,cameraVideo,cameraFallback,overlayHeading,overlayZone,gallery,captureButton,captureCountDisplay,captureProgressContainer,captureProgress,analyzeButton,deepAnalysisButton,saveReportButton,printReportButton,reportContent,reportLoader,reportTab,chatTab,reportView,chatView,chatMessages,chatInput,sendChatButton,roomSelectionContainer,currentRoomDisplay,roomLocationInput,floorNumberInput,holisticNextButton,userConcernsContainer,surroundingsWater,surroundingsHills;function getVastuZone(degrees){const ZONE_NAMES=["N (North)","NNE (North-North-East)","NE (North-East)","ENE (East-North-East)","E (East)","ESE (East-South-East)","SE (South-East)","SSE (South-South-East)","S (South)","SSW (South-South-West)","SW (South-West)","WSW (West-South-West)","W (West)","WNW (West-North-West)","NW (North-West)","NNW (North-North-West)"];const offset=11.25;let index=Math.floor(((degrees+offset)%360)/22.5);return ZONE_NAMES[index%16]}
function formatAITextForDisplay(rawText){let formattedText=rawText;formattedText=formattedText.replace(/\n\n/g,'<p></p>');formattedText=formattedText.replace(/\n/g,'<br>');formattedText=formattedText.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');return formattedText.length>0?`<div class="pdf-report-body">${formattedText}</div>`:''}
function displayCapturedFrames(){let html=`
                <strong class="no-print">VI.
Captured Visual Data Segments (${capturedFrames.length} Frames)</strong>
                <p class="text-sm font-semibold text-gray-600 mt-2 no-print">Scan Context: Data captured for the ${currentRoomTag} area, located in the ${roomLocationInHouse ||
'N/A'} of the entire property, on the ${floorNumber || 'N/A'}.</p>
                <div class="image-gallery">
            `;capturedFrames.forEach((frame,index)=>{const zone=getVastuZone(frame.heading);const imageUrl=`data:image/jpeg;base64,${frame.image}`;html+=`
                    <div class="frame-item">
                    
    <img src="${imageUrl}" alt="Segment ${index + 1}" title="Segment ${index + 1}: ${zone}">
                        <div class="frame-data">
                            <span class="text-xs font-bold text-blue-500">#${index + 1}</span> | 
                          
  ${frame.heading.toFixed(1)}° 
                        </div>
                    </div>
                `});html+=`</div>`;return html}
function formatAITextForTxtExport(rawText){let formattedText=rawText;formattedText=formattedText.replace(/\n\n/g,'\n\n');formattedText=formattedText.replace(/(?<!\n)\n(?!\n)/g,' ');formattedText=formattedText.replace(/\*\*(.*?)\*\*/g,(match,p1)=>`\n\n--- ${p1.toUpperCase()} ---\n`);return formattedText}
function updateNextStepHighlight(currentStep=1){stepContents.forEach((content,index)=>{const stepNum=index+1;stepIndicators[index].classList.remove('step-active');if(stepNum===currentStep){content.classList.remove('hidden');stepIndicators[index].classList.add('step-active')}else{content.classList.add('hidden')}});if(currentStep===4){cameraButton.disabled=!1}else if(currentStep===5){captureButton.disabled=isCapturing||capturedFrames.length>=totalCaptures}else if(currentStep===6){analyzeButton.disabled=isReportGenerating||capturedFrames.length<totalCaptures;deepAnalysisButton.disabled=isReportGenerating||capturedFrames.length<totalCaptures;chatInput.disabled=!fullReportMarkdown;sendChatButton.disabled=!fullReportMarkdown}}
function initializeRoomSelection(){const ROOM_TYPES=["Master Bedroom","Kitchen","Living Room","Pooja Room","Toilet/Bath","Main Entrance","Central Bhramsthan (Center of the Property)","General Property Scan (Central/General Area)"];roomSelectionContainer.innerHTML='';ROOM_TYPES.forEach(room=>{const btn=document.createElement('button');btn.textContent=room.replace(/\s*\(.*\)/,"");btn.className='room-select-btn p-2 text-xs rounded-full border border-gray-400 bg-white hover:bg-blue-100 transition-colors';btn.dataset.room=room;btn.onclick=()=>selectRoom(room,!1);roomSelectionContainer.appendChild(btn)});selectRoom(currentRoomTag,!1);roomLocationInput.value=roomLocationInHouse;floorNumberInput.value=floorNumber}
function selectRoom(roomName,shouldActivateCamera=!0){currentRoomTag=roomName;currentRoomDisplay.textContent=`Current Area: ${roomName}`;cameraButton.textContent=`Activate Camera for: ${roomName}`;cameraButton.disabled=!1;document.querySelectorAll('.room-select-btn').forEach(btn=>{btn.classList.remove('selected');if(btn.dataset.room===roomName){btn.classList.add('selected')}});if(roomName.includes("Central Bhramsthan")){roomLocationInput.value="Center";roomLocationInHouse="Center"}else if(roomLocationInput.value==="Center"||roomLocationInput.value.includes("N/A")||roomLocationInput.value===""){roomLocationInput.value="";roomLocationInHouse="";roomLocationInput.placeholder="E.g., North-East, South-West, Center (Required)"}
if(shouldActivateCamera&&currentRoomTag){activateCamera()}}
function switchReportTab(target){reportTab.classList.remove('border-blue-500','border-b-2','text-blue-800');chatTab.classList.remove('border-blue-500','border-b-2','text-blue-800');reportTab.classList.add('border-transparent','text-gray-600');chatTab.classList.add('border-transparent','text-gray-600');reportView.classList.add('hidden');chatView.classList.add('hidden');if(target==='report'){reportTab.classList.remove('border-transparent','text-gray-600');reportTab.classList.add('border-blue-500','border-b-2','text-blue-800');reportView.classList.remove('hidden')}else if(target==='chat'){chatTab.classList.remove('border-transparent','text-gray-600');chatTab.classList.add('border-blue-500','border-b-2','text-blue-800');chatView.classList.remove('hidden');setTimeout(()=>chatMessages.scrollTop=chatMessages.scrollHeight,10)}}
function handleOrientation(event){let heading;if(event.webkitCompassHeading){heading=event.webkitCompassHeading}else if(event.alpha!==null){heading=(360-event.alpha+360)%360}else{return}
if(sensorCheckTimeout){clearTimeout(sensorCheckTimeout);sensorCheckTimeout=null}
currentHeading=parseFloat(heading.toFixed(1));headingDisplay.textContent=`Heading: ${currentHeading}°`;overlayHeading.textContent=`${currentHeading}°`;compassNeedle.style.transform=`rotate(-${currentHeading}deg)`;overlayZone.textContent=`Zone: ${getVastuZone(currentHeading)}`}
function requestIOSSensorPermission(){if(typeof DeviceOrientationEvent.requestPermission==='function'){DeviceOrientationEvent.requestPermission().then(permissionState=>{if(permissionState==='granted'){window.addEventListener('deviceorientation',handleOrientation);window.addEventListener('deviceorientationabsolute',handleOrientation);startCompassLogic()}else{startCompassSimulation()}}).catch(e=>{console.error('Sensor permission error:',e);startCompassSimulation()})}else{startCompassLogic()}}
function startCompassLogic(){if(isCompassActive)return;if(window.DeviceOrientationEvent){if(typeof DeviceOrientationEvent.requestPermission!=='function'||isCompassActive===!1){window.addEventListener('deviceorientation',handleOrientation);window.addEventListener('deviceorientationabsolute',handleOrientation)}}else{startCompassSimulation();return}
sensorCheckTimeout=setTimeout(()=>{if(currentHeading===null){stopCompassLogic();startCompassSimulation()}},1000);isCompassActive=!0;sensorStatus.textContent='Sensors: Active';compassButton.classList.remove('primary-btn');compassButton.classList.add('bg-gray-400');compassButton.textContent='Sensors Active';compassButton.disabled=!0;updateNextStepHighlight(3)}
function startCompassSimulation(){if(isCompassActive)return;isCompassActive=!0;let simHeading=0;sensorStatus.textContent='Sensors: SIMULATION (Not Found)';simulationInterval=setInterval(()=>{simHeading=(simHeading+0.1)%360;currentHeading=parseFloat(simHeading.toFixed(1));headingDisplay.textContent=`Heading: ${currentHeading}° (SIM)`;overlayHeading.textContent=`${currentHeading}° (SIM)`;compassNeedle.style.transform=`rotate(-${currentHeading}deg)`;overlayZone.textContent=`Zone: ${getVastuZone(currentHeading)}`},100);compassButton.classList.remove('primary-btn');compassButton.classList.add('bg-gray-400');compassButton.textContent='Simulation Active';compassButton.disabled=!0;updateNextStepHighlight(3)}
function activateCompass(){if(isCompassActive)return;if(window.DeviceOrientationEvent&&typeof DeviceOrientationEvent.requestPermission==='function'){requestIOSSensorPermission()}else if(window.DeviceOrientationEvent){startCompassLogic()}else{startCompassSimulation()}}
function stopVideoStream(){if(videoStream){videoStream.getTracks().forEach(track=>track.stop());videoStream=null;isCameraActive=!1;cameraVideo.classList.add('hidden');cameraFallback.classList.remove('hidden')}}
function stopCompassLogic(){if(!isCompassActive)return;isCompassActive=!1;sensorStatus.textContent='Sensors: Inactive';compassButton.classList.remove('bg-gray-400');compassButton.classList.add('primary-btn');compassButton.textContent='Activate Sensors';compassButton.disabled=!1;headingDisplay.textContent='Heading: N/A';overlayHeading.textContent='N/A';compassNeedle.style.transform=`rotate(0deg)`;overlayZone.textContent='Zone: Unknown';window.removeEventListener('deviceorientation',handleOrientation);window.removeEventListener('deviceorientationabsolute',handleOrientation);if(simulationInterval){clearInterval(simulationInterval);simulationInterval=null}
if(sensorCheckTimeout){clearTimeout(sensorCheckTimeout);sensorCheckTimeout=null}}
async function activateCamera(){if(isCameraActive)return;if(!currentRoomTag){return}
try{videoStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment',width:{ideal:320},height:{ideal:320}}});cameraVideo.srcObject=videoStream;cameraVideo.classList.remove('hidden');cameraFallback.classList.add('hidden');await cameraVideo.play();isCameraActive=!0;cameraButton.textContent=`Camera Active for: ${currentRoomTag}`;cameraButton.disabled=!0;cameraButton.classList.remove('primary-btn');cameraButton.classList.add('bg-gray-400');updateNextStepHighlight(5)}catch(err){console.error('Camera access error:',err);cameraVideo.classList.add('hidden');cameraFallback.classList.remove('hidden')}}
function captureCurrentFrame(){const video=cameraVideo;const canvas=captureCanvas;const context=canvas.getContext('2d');if(!isCameraActive||!currentHeading){console.error("Cannot capture: Camera or compass is inactive.");return null}
if(video.videoWidth===0||video.videoHeight===0){console.warn("Video dimensions not ready yet. Skipping this frame capture.");return null}
const size=Math.min(video.videoWidth,video.videoHeight);canvas.width=size;canvas.height=size;const startX=(video.videoWidth-size)/2;const startY=(video.videoHeight-size)/2;context.drawImage(video,startX,startY,size,size,0,0,size,size);const dataUrl=canvas.toDataURL('image/jpeg',0.05);const base64Data=dataUrl.split(',')[1];return{image:base64Data,heading:currentHeading,zone:getVastuZone(currentHeading),timestamp:Date.now()}}
function startCapture(){if(isCapturing||!isCompassActive||!isCameraActive){alert("Please ensure sensors and camera are active (Steps 2 & 4).");return}
if(!roomLocationInHouse||roomLocationInput.value.includes("N/A")||roomLocationInHouse.length<2){alert("Please complete Step 4b: 'Where is this area located?' before scanning.");return}
if(!floorNumber||floorNumber.length<1){alert("Please complete Step 4c: 'Which floor is this area located on?' before scanning.");return}
isCapturing=!0;capturedFrames=[];captureCountDisplay.textContent=`0/${totalCaptures}`;captureButton.disabled=!0;captureButton.textContent='Scanning... (Hold Steady)';gallery.innerHTML='';captureProgressContainer.classList.remove('hidden');captureProgress.style.width='0%';analyzeButton.disabled=!0;deepAnalysisButton.disabled=!0;saveReportButton.classList.add('hidden');printReportButton.classList.add('hidden');let capturesTaken=0;const executeCapture=()=>{const frameData=captureCurrentFrame();if(frameData){capturedFrames.push(frameData);capturesTaken++;displayCapturedFramesInGallery();captureCountDisplay.textContent=`${capturesTaken}/${totalCaptures}`;captureProgress.style.width=`${(capturesTaken / totalCaptures) * 100}%`;if(capturesTaken>=totalCaptures){clearInterval(captureInterval);endCapture()}}};executeCapture();captureInterval=setInterval(executeCapture,captureIntervalTime);setTimeout(()=>{if(isCapturing){clearInterval(captureInterval);endCapture()}},captureIntervalTime*totalCaptures+500)}
function endCapture(){isCapturing=!1;captureProgressContainer.classList.add('hidden');captureButton.textContent='Start 16-Second Vastu Scan';captureButton.disabled=!1;stopVideoStream();stopCompassLogic();if(capturedFrames.length===totalCaptures){updateNextStepHighlight(6);analyzeButton.disabled=!1;deepAnalysisButton.disabled=!1}else{updateNextStepHighlight(6);analyzeButton.disabled=!0;deepAnalysisButton.disabled=!0}}
function displayCapturedFramesInGallery(){gallery.innerHTML='';capturedFrames.forEach((frame,index)=>{const img=document.createElement('img');img.src=`data:image/jpeg;base64,${frame.image}`;img.className='w-16 h-16 object-cover rounded-md border border-gray-300';img.title=`Segment ${index + 1}: ${frame.zone} (${frame.heading}°)`;const container=document.createElement('div');container.className='relative flex flex-col items-center justify-center p-1';const label=document.createElement('span');label.className='text-xxs text-center text-gray-500 mt-1 truncate w-16';label.textContent=`${getVastuZone(frame.heading).split(' ')[0]} (${index + 1})`;container.appendChild(img);container.appendChild(label);gallery.appendChild(container)})}
async function generateReport(isDeepAnalysis=!1){if(isReportGenerating||capturedFrames.length<totalCaptures){return}
if(renderApiUrl.includes("YOUR_RENDER_URL_HERE")||renderApiUrl.length<10){reportContent.innerHTML=formatAITextForDisplay(`**Error:** Server not configured. Please paste your Render server's URL into the 'renderApiUrl' variable at the top of the script.`);return}
isReportGenerating=!0;fullReportMarkdown="";chatContextSummary="";chatHistory=[];reportContent.innerHTML=displayCapturedFrames();reportLoader.classList.remove('hidden');analyzeButton.disabled=!0;deepAnalysisButton.disabled=!0;saveReportButton.classList.add('hidden');printReportButton.classList.add('hidden');chatInput.disabled=!0;sendChatButton.disabled=!0;let holisticIssues="None specified";if(userIssues.length>0){holisticIssues=userIssues.join(', ')}
let holisticSurroundings="None specified";const surroundingsEntries=Object.entries(propertySurroundings).filter(([key,value])=>value.trim()!=="");if(surroundingsEntries.length>0){holisticSurroundings=surroundingsEntries.map(([key,value])=>`${key}: ${value}`).join('; ')}
const clientPayload={isDeepAnalysis:isDeepAnalysis,scanData:{capturedFrames:capturedFrames.map(f=>({image:f.image,heading:f.heading,zone:f.zone})),currentRoomTag:currentRoomTag,roomLocationInHouse:roomLocationInHouse,floorNumber:floorNumber,holisticIssues:holisticIssues,holisticSurroundings:holisticSurroundings}};try{const apiUrl=`${renderApiUrl}/api/generateReport`;const response=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(clientPayload)});if(!response.ok){const errorData=await response.json();throw new Error(`Server Error: ${response.status} - ${errorData.error || 'Failed to fetch'}`)}
const result=await response.json();fullReportMarkdown=result.text||"";if(!fullReportMarkdown){throw new Error("API returned an empty response. This is likely due to the API's safety filters (e.g., a blurry/dark image) or a silent timeout. Please try scanning again in a well-lit area.")}
const summaryEndMarker='**II. Directional Data and Environmental Assessment**';const summaryEndIndex=fullReportMarkdown.indexOf(summaryEndMarker);if(summaryEndIndex!==-1){chatContextSummary=fullReportMarkdown.substring(0,summaryEndIndex).trim()}else{chatContextSummary=fullReportMarkdown.substring(0,500).trim()}
reportContent.innerHTML=formatAITextForDisplay(fullReportMarkdown)+displayCapturedFrames();saveReportButton.classList.remove('hidden');printReportButton.classList.remove('hidden');chatInput.disabled=!1;sendChatButton.disabled=!1}catch(error){console.error('Report Generation Error:',error);let errorHtml=formatAITextForDisplay(`**I. Executive Summary (Layman's Terms)**\n\nReport generation failed due to an error.`);errorHtml+=`<p class="text-red-600 font-bold mt-4">REPORT GENERATION FAILED</p>
                              <p class="mt-2 text-sm">A critical API error occurred.
Please try running the scan again.</p>
                              <p class="mt-2 text-xs text-gray-400">Error Details: ${error.message}</p>`;reportContent.innerHTML=errorHtml+displayCapturedFrames()}finally{isReportGenerating=!1;reportLoader.classList.add('hidden');analyzeButton.disabled=!1;deepAnalysisButton.disabled=!1}}
function exportReportAsTxt(){if(!fullReportMarkdown){return}
saveReportButton.disabled=!0;const header=`
*** Vastu Pro Analyzer Formal AI Report ***
Scan Area: ${currentRoomTag} 
Location in House (C-Point): ${roomLocationInHouse ||
'N/A'}
Floor: ${floorNumber || 'N/A'}
----------------------------------------------------------------------------------------------------------------------
\n`;const formattedBody=formatAITextForTxtExport(fullReportMarkdown);const footer=`
\n----------------------------------------------------------------------------------------------------------------------
*** Captured Visual Data Segments (Images are NOT included in this text file) ***
${capturedFrames.map((f, i) => `#${i+1}:${f.heading.toFixed(1)}degrees(${f.zone})`).join(' | ')}
----------------------------------------------------------------------------------------------------------------------
This file contains the full Vastu analysis.
\n`;const fullTextContent=header+formattedBody+footer;const blob=new Blob([fullTextContent],{type:'text/plain'});const a=document.createElement('a');a.download=`Vastu_Report_${Date.now()}.txt`;a.href=URL.createObjectURL(blob);document.body.appendChild(a);a.click();document.body.removeChild(a);saveReportButton.disabled=!1}
function appendMessage(text,sender){const msgDiv=document.createElement('div');msgDiv.className=`chat-message ${sender}-message`;if(sender==='ai'){let formattedText=text.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>');formattedText=formattedText.replace(/\n/g,'<br>');msgDiv.innerHTML=`<i class="fas fa-robot mr-1 text-blue-500"></i> ${formattedText}`}else{msgDiv.textContent=text}
chatMessages.appendChild(msgDiv);chatMessages.scrollTop=chatMessages.scrollHeight}
async function handleChat(){const userText=chatInput.value.trim();if(!userText||isChatGenerating)return;if(renderApiUrl.includes("YOUR_RENDER_URL_HERE")||renderApiUrl.length<10){appendMessage("Error: Chat server not configured.",'ai');return}
appendMessage(userText,'user');chatInput.value='';isChatGenerating=!0;chatInput.disabled=!0;sendChatButton.disabled=!0;chatHistory.push({role:"user",parts:[{text:userText}]});const chatHistoryToSend=chatHistory.slice(-3);const clientPayload={chatHistory:chatHistoryToSend,chatContextSummary:chatContextSummary};try{const apiUrl=`${renderApiUrl}/api/handleChat`;const response=await fetch(apiUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(clientPayload)});if(!response.ok){const errorData=await response.json();throw new Error(`Server Error: ${response.status} - ${errorData.error || 'Failed to fetch'}`)}
const result=await response.json();const aiResponse=result.text||"Sorry, I couldn't process that query.";appendMessage(aiResponse,'ai');chatHistory.push({role:"model",parts:[{text:aiResponse}]})}catch(error){console.error('Chatbot Error:',error);appendMessage(`I apologize, I encountered an error: ${error.message}. Please try again.`,'ai')}finally{isChatGenerating=!1;chatInput.disabled=!1;sendChatButton.disabled=chatInput.value.trim()===''||isChatGenerating;chatInput.focus()}}
document.addEventListener('DOMContentLoaded',()=>{stepContents=[1,2,3,4,5,6].map(i=>document.getElementById(`stepContent${i}`));stepIndicators=[1,2,3,4,5,6].map(i=>document.getElementById(`step${i}`));tipsNextButton=document.getElementById('tipsNextButton');headingDisplay=document.getElementById('headingDisplay');sensorStatus=document.getElementById('sensorStatus');compassNeedle=document.getElementById('compassNeedle');compassButton=document.getElementById('compassButton');cameraButton=document.getElementById('cameraButton');captureCanvas=document.getElementById('captureCanvas');cameraVideo=document.getElementById('cameraVideo');cameraFallback=document.getElementById('cameraFallback');overlayHeading=document.getElementById('overlayHeading');overlayZone=document.getElementById('overlayZone');gallery=document.getElementById('gallery');captureButton=document.getElementById('captureButton');captureCountDisplay=document.getElementById('captureCount');captureProgressContainer=document.getElementById('captureProgressContainer');captureProgress=document.getElementById('captureProgress');analyzeButton=document.getElementById('analyzeButton');deepAnalysisButton=document.getElementById('deepAnalysisButton');saveReportButton=document.getElementById('saveReportButton');printReportButton=document.getElementById('printReportButton');reportContent=document.getElementById('reportContent');reportLoader=document.getElementById('reportLoader');reportTab=document.getElementById('reportTab');chatTab=document.getElementById('chatTab');reportView=document.getElementById('reportView');chatView=document.getElementById('chatView');chatMessages=document.getElementById('chatMessages');chatInput=document.getElementById('chatInput');sendChatButton=document.getElementById('sendChatButton');roomSelectionContainer=document.getElementById('roomSelectionContainer');currentRoomDisplay=document.getElementById('currentRoomDisplay');roomLocationInput=document.getElementById('roomLocationInput');floorNumberInput=document.getElementById('floorNumberInput');holisticNextButton=document.getElementById('holisticNextButton');userConcernsContainer=document.getElementById('userConcernsContainer');surroundingsWater=document.getElementById('surroundingsWater');surroundingsHills=document.getElementById('surroundingsHills');initializeRoomSelection();updateNextStepHighlight();switchReportTab('report');tipsNextButton.addEventListener('click',()=>updateNextStepHighlight(2));holisticNextButton.addEventListener('click',()=>updateNextStepHighlight(4));compassButton.addEventListener('click',activateCompass);cameraButton.addEventListener('click',()=>{if(document.getElementById('stepContent4').classList.contains('hidden'))return;selectRoom(currentRoomTag,!0)});captureButton.addEventListener('click',startCapture);analyzeButton.addEventListener('click',()=>generateReport(!1));deepAnalysisButton.addEventListener('click',()=>generateReport(!0));saveReportButton.addEventListener('click',exportReportAsTxt);printReportButton.addEventListener('click',()=>window.print());userConcernsContainer.addEventListener('change',(e)=>{if(e.target.type==='checkbox'){userIssues=Array.from(userConcernsContainer.querySelectorAll('input:checked')).map(cb=>cb.value)}});surroundingsWater.addEventListener('input',()=>{propertySurroundings[surroundingsWater.dataset.key]=surroundingsWater.value});surroundingsHills.addEventListener('input',()=>{propertySurroundings[surroundingsHills.dataset.key]=surroundingsHills.value});roomLocationInput.addEventListener('input',()=>{roomLocationInHouse=roomLocationInput.value.trim()});floorNumberInput.addEventListener('input',()=>{floorNumber=floorNumberInput.value.trim()});reportTab.addEventListener('click',()=>switchReportTab('report'));chatTab.addEventListener('click',()=>{if(fullReportMarkdown){switchReportTab('chat')}else{switchReportTab('report')}});sendChatButton.addEventListener('click',handleChat);chatInput.addEventListener('keypress',(e)=>{if(e.key==='Enter'){handleChat()}});chatInput.addEventListener('input',()=>{sendChatButton.disabled=chatInput.value.trim()===''||isChatGenerating})})
</script>
</body>
</html>